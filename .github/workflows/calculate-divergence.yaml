name: Branch Divergence Score

on:
  workflow_dispatch:  # You can also use: schedule: [cron] or push:
  push:
    branches: 
      - "**"

jobs:
  divergence-score:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed to access all commits and branches

    - name: Calculate divergence score
      run: |
        echo "Calculating divergence from origin/main for all remote branches..."
        git fetch --all

        main_branch="origin/main"
        total_insertions=0
        total_deletions=0

        for branch in $(git branch -r | grep -v 'origin/HEAD' | grep -v 'origin/main'); do
          if [[ "$branch" != "$main_branch" && "$branch" != origin/HEAD ]]; then
            # Check if the branch has been fully merged into main
            git merge-base --is-ancestor $branch $main_branch
            if git merge-base --is-ancestor $branch $main_branch; then
              echo "‚úÖ $branch has already been merged into $main_branch ‚Äî skipping."
              continue
            fi

            base=$(git merge-base $main_branch $branch)
            stats=$(git diff --shortstat $base..$branch)

            echo "üîç $branch ‚Äî $stats"

            insertions=$(echo "$stats" | grep -o '[0-9]* insertions' | grep -o '[0-9]*')
            deletions=$(echo "$stats" | grep -o '[0-9]* deletions' | grep -o '[0-9]*')

            insertions=${insertions:-0}
            deletions=${deletions:-0}

            total_insertions=$((total_insertions + insertions))
            total_deletions=$((total_deletions + deletions))
          fi
        done

        total_score=$((total_insertions + total_deletions))

        echo "‚úÖ Total Insertions: $total_insertions"
        echo "‚úÖ Total Deletions: $total_deletions"
        echo "üéØ Total Divergence Score: $total_score"