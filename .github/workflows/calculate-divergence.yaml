name: Branch Divergence Score

on:
  workflow_dispatch:  # You can also use: schedule: [cron] or push:
  push:
    branches: 
      - "**"

jobs:
  divergence-score:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed to access all commits and branches

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Calculate divergence score
      run: |
        echo "Calculating divergence from origin/main for all remote branches..."
        git fetch --all

        main_branch="origin/main"
        total_insertions=0
        total_deletions=0
        branch_count=0

        for branch in $(git branch -r | grep -v 'origin/HEAD' | grep -v 'origin/main'); do
          if [[ "$branch" != "$main_branch" && "$branch" != origin/HEAD ]]; then
            # Check if the branch has been fully merged into main
            if git merge-base --is-ancestor $branch $main_branch; then
              echo "âœ… $branch has already been merged into $main_branch â€” skipping."
              continue
            fi

            latest_commit_sha=$(git rev-parse $branch)
            latest_commit_date=$(git show -s --format=%ct $branch)

            if [[ -z "$newest_commit_sha" || "$latest_commit_date" -gt "$newest_commit_unix" ]]; then
              newest_commit_sha=$latest_commit_sha
              newest_commit_unix=$latest_commit_date
            fi

            branch_count=$((branch_count + 1))  # âœ… Count this branch
            base=$(git merge-base $main_branch $branch)
            stats=$(git diff --shortstat $base..$branch)

            echo "ðŸ” $branch â€” $stats"

            insertions=$(echo "$stats" | grep -o '[0-9]\+ insertions' | grep -o '[0-9]\+' || echo "0")
            deletions=$(echo "$stats" | grep -o '[0-9]\+ deletions' | grep -o '[0-9]\+' || echo "0")

            insertions=${insertions:-0}
            deletions=${deletions:-0}

            total_insertions=$((total_insertions + insertions))
            total_deletions=$((total_deletions + deletions))
          fi
        done

        echo "âœ… Total Insertions: $total_insertions"
        echo "âœ… Total Deletions: $total_deletions"
        echo "âœ… Total Deletions: $branch_count"
        total_score=$(( (total_insertions + total_deletions) * branch_count ))

        echo "ðŸŽ¯ Total Divergence Score: $total_score"
        curl -s -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/$newest_commit_sha/comments \
          -d "$(jq -n --arg body "Divergence: $total_score" '{ body: $body }')"

        echo "**ðŸ§® Divergence Score:** \`$total_score\`" >> $GITHUB_STEP_SUMMARY